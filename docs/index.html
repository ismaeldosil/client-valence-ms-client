<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MS Teams Client - Valerie Chat Clients</title>
    <link rel="stylesheet" href="common/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: true,
                theme: 'base',
                themeVariables: {
                    primaryColor: '#fb511f',
                    primaryTextColor: '#fff',
                    primaryBorderColor: '#e95d34',
                    lineColor: '#353637',
                    secondaryColor: '#f4f4f4',
                    tertiaryColor: '#ffffff',
                    fontFamily: 'Roboto, sans-serif'
                },
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true,
                    curve: 'basis'
                }
            });
        });
    </script>
</head>
<body>
    <!-- Navigation -->
    <nav class="version-nav">
        <div class="nav-container">
            <div class="nav-brand">REEA Global <span>Valerie</span></div>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Home</a>
                <a href="index.html" class="nav-link active">MS Teams</a>
                <a href="#" class="nav-link">Slack</a>
                <a href="#" class="nav-link">Architecture</a>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <header>
        <div class="container">
            <h1>MS Teams Client</h1>
            <p class="subtitle">Microsoft Teams Integration for Valerie AI Agent</p>
            <div class="meta-info">
                <span class="meta-item">Outgoing Webhook</span>
                <span class="meta-item">HMAC-SHA256</span>
                <span class="meta-item">Redis Sessions</span>
                <span class="meta-item">Railway Deployed</span>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Status Alert -->
        <section>
            <div class="alert alert-warning">
                <strong>Microsoft Incident MO1176905 - Webhook Creation Blocked</strong>
                Microsoft is currently experiencing issues with Outgoing Webhooks. The webhook creation and configuration process is blocked. The client is deployed and ready, but cannot receive messages from Teams until Microsoft resolves this incident.
            </div>
        </section>

        <!-- Overview -->
        <section>
            <h2>Overview</h2>
            <p>The MS Teams Client provides integration between Microsoft Teams and the Valerie AI Agent. It uses Teams Outgoing Webhooks to receive messages when users @mention the bot in channels, processes them through the Valerie Agent, and returns responses.</p>

            <div class="metric-grid">
                <div class="metric-card">
                    <div class="value">Webhook</div>
                    <div class="label">Connection Type</div>
                </div>
                <div class="metric-card">
                    <div class="value">5s</div>
                    <div class="label">Response Limit</div>
                </div>
                <div class="metric-card">
                    <div class="value">24h</div>
                    <div class="label">Session TTL</div>
                </div>
                <div class="metric-card">
                    <div class="value">HMAC</div>
                    <div class="label">Authentication</div>
                </div>
            </div>
        </section>

        <!-- Architecture -->
        <section>
            <h2>Architecture</h2>
            <div class="mermaid-container">
                <pre class="mermaid">
flowchart TD
    subgraph teams["MS Teams"]
        A[("User Message<br/>@BotName")]
    end

    subgraph webhook["Outgoing Webhook"]
        B["HTTPS POST<br/>HMAC Signature"]
    end

    subgraph client["Teams Client (Railway)"]
        C["Webhook Handler"]
        C1["1. Verify HMAC"]
        C2["2. Parse Message"]
        C3["3. Get Session"]
        C4["4. Call Agent"]
        C5["5. Save Session"]
        C --> C1 --> C2 --> C3 --> C4 --> C5
    end

    subgraph session["Session Layer"]
        D[("Redis Session Store")]
    end

    subgraph agent["Valerie Agent"]
        E["POST /api/v1/chat<br/>{session_id, message, history}"]
    end

    A -->|"@BotName message"| webhook
    B -->|"POST /webhook<br/>Authorization: HMAC"| C
    C3 -->|"Get/Create"| D
    C4 -->|"Chat Request"| E
    E -->|"AI Response"| C5
    C5 -->|"Save"| D
    C5 -->|"JSON Response"| webhook
    webhook -->|"Display Message"| teams

    style teams fill:#5558AF,stroke:#5558AF,color:#fff
    style webhook fill:#7B83EB,stroke:#7B83EB,color:#fff
    style client fill:#fb511f,stroke:#e95d34,color:#fff
    style session fill:#2EB67D,stroke:#2EB67D,color:#fff
    style agent fill:#36C5F0,stroke:#36C5F0,color:#fff
                </pre>
            </div>
        </section>

        <!-- Production URL -->
        <section>
            <h2>Production Deployment</h2>
            <div class="winner-card">
                <h3>Teams Client</h3>
                <div class="winner-metrics">
                    <div class="winner-metric">
                        <div class="value">Railway</div>
                        <div class="label">Platform</div>
                    </div>
                    <div class="winner-metric">
                        <div class="value">Redis</div>
                        <div class="label">Sessions</div>
                    </div>
                    <div class="winner-metric">
                        <div class="value">HTTPS</div>
                        <div class="label">Protocol</div>
                    </div>
                    <div class="winner-metric">
                        <div class="value">Auto</div>
                        <div class="label">Deploy</div>
                    </div>
                </div>
            </div>
            <p style="text-align: center; margin-top: 1rem;">
                <a href="https://teams-client-production.up.railway.app" target="_blank">https://teams-client-production.up.railway.app</a>
            </p>
        </section>

        <!-- Endpoints -->
        <section>
            <h2>API Endpoints</h2>
            <table>
                <thead>
                    <tr>
                        <th>Method</th>
                        <th>Endpoint</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="badge badge-info">GET</span></td>
                        <td><code>/</code></td>
                        <td>Redirects to dashboard</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-info">GET</span></td>
                        <td><code>/health</code></td>
                        <td>Health check endpoint for Railway</td>
                    </tr>
                    <tr class="highlight-row">
                        <td><span class="badge badge-success">POST</span></td>
                        <td><code>/webhook</code></td>
                        <td>Teams Outgoing Webhook receiver</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-info">GET</span></td>
                        <td><code>/webhook</code></td>
                        <td>Webhook validation endpoint</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-info">GET</span></td>
                        <td><code>/dashboard</code></td>
                        <td>Web dashboard interface</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-info">GET</span></td>
                        <td><code>/dashboard/api/status</code></td>
                        <td>Client and agent status</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-info">GET</span></td>
                        <td><code>/dashboard/api/sessions</code></td>
                        <td>Session store statistics</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-info">GET</span></td>
                        <td><code>/dashboard/api/config</code></td>
                        <td>Non-sensitive configuration</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-success">POST</span></td>
                        <td><code>/dashboard/api/test/agent</code></td>
                        <td>Test agent connection</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-success">POST</span></td>
                        <td><code>/dashboard/api/test/webhook</code></td>
                        <td>Simulate webhook message</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-info">GET</span></td>
                        <td><code>/docs</code></td>
                        <td>Documentation page</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-info">GET</span></td>
                        <td><code>/docs/webhook-status</code></td>
                        <td>Webhook status report</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Environment Variables -->
        <section>
            <h2>Environment Variables</h2>
            <table>
                <thead>
                    <tr>
                        <th>Variable</th>
                        <th>Description</th>
                        <th>Required</th>
                        <th>Default</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>ENVIRONMENT</code></td>
                        <td>Environment name</td>
                        <td><span class="badge badge-info">No</span></td>
                        <td>development</td>
                    </tr>
                    <tr>
                        <td><code>LOG_LEVEL</code></td>
                        <td>Logging level</td>
                        <td><span class="badge badge-info">No</span></td>
                        <td>DEBUG</td>
                    </tr>
                    <tr class="highlight-row">
                        <td><code>TEAMS_HMAC_SECRET</code></td>
                        <td>Base64 encoded HMAC secret from Teams webhook</td>
                        <td><span class="badge badge-warning">Yes*</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td><code>RECEIVER_PORT</code></td>
                        <td>Webhook receiver port</td>
                        <td><span class="badge badge-info">No</span></td>
                        <td>3001</td>
                    </tr>
                    <tr class="highlight-row">
                        <td><code>AGENT_BASE_URL</code></td>
                        <td>Valerie Agent API URL</td>
                        <td><span class="badge badge-danger">Yes</span></td>
                        <td>http://localhost:8000</td>
                    </tr>
                    <tr>
                        <td><code>AGENT_API_KEY</code></td>
                        <td>Agent API key (optional)</td>
                        <td><span class="badge badge-info">No</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td><code>AGENT_TIMEOUT</code></td>
                        <td>Request timeout (must be &lt;5s for Teams)</td>
                        <td><span class="badge badge-info">No</span></td>
                        <td>4.5</td>
                    </tr>
                    <tr>
                        <td><code>AGENT_MAX_RETRIES</code></td>
                        <td>Max retry attempts</td>
                        <td><span class="badge badge-info">No</span></td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td><code>SESSION_STORE</code></td>
                        <td>Session store type (memory/redis)</td>
                        <td><span class="badge badge-info">No</span></td>
                        <td>memory</td>
                    </tr>
                    <tr>
                        <td><code>SESSION_TTL_HOURS</code></td>
                        <td>Session time-to-live in hours</td>
                        <td><span class="badge badge-info">No</span></td>
                        <td>24</td>
                    </tr>
                    <tr>
                        <td><code>REDIS_URL</code></td>
                        <td>Redis connection URL</td>
                        <td><span class="badge badge-warning">Yes*</span></td>
                        <td>redis://localhost:6379/0</td>
                    </tr>
                    <tr>
                        <td><code>TEAMS_WORKFLOW_ALERTS</code></td>
                        <td>Power Automate URL for alerts</td>
                        <td><span class="badge badge-info">No</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td><code>TEAMS_WORKFLOW_REPORTS</code></td>
                        <td>Power Automate URL for reports</td>
                        <td><span class="badge badge-info">No</span></td>
                        <td>-</td>
                    </tr>
                </tbody>
            </table>
            <p><small>* Required for production deployment with full functionality</small></p>
        </section>

        <!-- Redis Sessions -->
        <section>
            <h2>Redis Session Management</h2>
            <p>The Teams client uses Redis to maintain conversation history across messages. Each conversation gets a unique session that stores message history.</p>

            <h3>Session Key Format</h3>
            <div class="code-block"><pre>
session:teams:{conversation_id}
            </pre></div>

            <h3>Session Data Structure</h3>
            <div class="code-block"><pre>
{
    "session_id": "teams-conversation-123",
    "user_id": "user-aad-object-id",
    "platform": "teams",
    "messages": [
        {"role": "user", "content": "Hello"},
        {"role": "assistant", "content": "Hi there!"}
    ],
    "created_at": "2025-01-12T10:00:00Z",
    "updated_at": "2025-01-12T10:05:00Z",
    "ttl_hours": 24
}
            </pre></div>

            <h3>Features</h3>
            <ul class="feature-list">
                <li><strong>Automatic TTL</strong> - Sessions expire after 24 hours of inactivity</li>
                <li><strong>Message History</strong> - Conversation context is maintained for follow-up questions</li>
                <li><strong>Platform Isolation</strong> - Teams sessions are separate from Slack sessions</li>
                <li><strong>Graceful Fallback</strong> - Falls back to memory store if Redis is unavailable</li>
            </ul>
        </section>

        <!-- HMAC Verification -->
        <section>
            <h2>HMAC Signature Verification</h2>
            <p>Teams Outgoing Webhooks include an HMAC-SHA256 signature in the Authorization header. The client verifies this signature to ensure messages are authentic.</p>

            <h3>Verification Process</h3>
            <div class="code-block"><pre>
# Request from Teams
Authorization: HMAC &lt;base64-signature&gt;

# Verification steps:
1. Extract signature from Authorization header
2. Base64 decode the TEAMS_HMAC_SECRET
3. Compute HMAC-SHA256 of request body using secret
4. Base64 encode the computed hash
5. Compare with provided signature
            </pre></div>

            <h3>Configuration</h3>
            <div class="alert alert-info">
                <strong>Getting the HMAC Secret</strong>
                When you create an Outgoing Webhook in Teams, Microsoft provides a security token (Base64 encoded). Copy this token and set it as the <code>TEAMS_HMAC_SECRET</code> environment variable.
            </div>

            <h3>Verification Logic</h3>
            <ul class="feature-list">
                <li><strong>No Auth Header</strong> - Accept request (validation from Teams during webhook creation)</li>
                <li><strong>Auth Header + Secret Configured</strong> - Validate signature, reject if invalid</li>
                <li><strong>Auth Header + No Secret</strong> - Accept with warning (setup not complete)</li>
            </ul>
        </section>

        <!-- Dashboard -->
        <section>
            <h2>Dashboard Features</h2>
            <p>The web dashboard provides monitoring and testing capabilities for the Teams client.</p>

            <div class="comparison-grid">
                <div class="comparison-card">
                    <h4>Status Monitoring</h4>
                    <ul>
                        <li><span>Client Health</span><span class="badge badge-success">Live</span></li>
                        <li><span>Agent Connection</span><span class="badge badge-success">Live</span></li>
                        <li><span>Redis Sessions</span><span class="badge badge-success">Live</span></li>
                        <li><span>HMAC Status</span><span class="badge badge-info">Config</span></li>
                    </ul>
                </div>
                <div class="comparison-card">
                    <h4>Testing Tools</h4>
                    <ul>
                        <li><span>Test Agent</span><span>Send message to agent</span></li>
                        <li><span>Test Webhook</span><span>Simulate Teams message</span></li>
                        <li><span>Test Workflow</span><span>Send to Power Automate</span></li>
                        <li><span>View Sessions</span><span>Session statistics</span></li>
                    </ul>
                </div>
            </div>

            <p style="margin-top: 1rem;">
                Access the dashboard at: <a href="https://teams-client-production.up.railway.app/dashboard" target="_blank">https://teams-client-production.up.railway.app/dashboard</a>
            </p>
        </section>

        <!-- Known Limitations -->
        <section>
            <h2>Known Limitations</h2>
            <div class="alert alert-warning">
                <strong>Microsoft Teams Outgoing Webhook Limitations</strong>
                These are inherent limitations of the Teams Outgoing Webhook platform.
            </div>

            <ul class="feature-list">
                <li><strong>5-second timeout</strong> - Teams requires responses within 5 seconds. Complex queries may timeout.</li>
                <li><strong>Standard Channels Only</strong> - Outgoing Webhooks do not work in Shared Channels.</li>
                <li><strong>@mention Required</strong> - Users must @mention the bot name to trigger the webhook.</li>
                <li><strong>No Adaptive Cards in Response</strong> - Outgoing Webhooks only support plain text responses.</li>
                <li><strong>Public URL Required</strong> - The webhook endpoint must be accessible from the internet.</li>
                <li><strong>Single Team</strong> - Each webhook is configured for a single team.</li>
            </ul>
        </section>

        <!-- Commands -->
        <section>
            <h2>Available Commands</h2>
            <table>
                <thead>
                    <tr>
                        <th>Command</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>/help</code></td>
                        <td>Show available commands and usage instructions</td>
                    </tr>
                    <tr>
                        <td><code>/status</code></td>
                        <td>Check connection status to the Valerie Agent</td>
                    </tr>
                    <tr>
                        <td><code>/clear</code></td>
                        <td>Clear conversation history and start fresh</td>
                    </tr>
                </tbody>
            </table>

            <h3>Usage Example</h3>
            <div class="code-block"><pre>
# In MS Teams channel:
@Valerie /help
@Valerie What is machine learning?
@Valerie /clear
            </pre></div>
        </section>

        <!-- Development Timeline -->
        <section>
            <h2>Development Timeline (Bitacora)</h2>
            <div class="timeline">
                <div class="timeline-item">
                    <div class="date">December 26, 2024</div>
                    <div class="title">Phase 0: Testing & Mocks</div>
                    <div class="description">Created mock servers for Agent and Webhook testing. Established project structure and base infrastructure.</div>
                </div>
                <div class="timeline-item">
                    <div class="date">December 27, 2024</div>
                    <div class="title">Phase 1: Notifications</div>
                    <div class="description">Implemented Power Automate Workflow integration for Agent-to-Teams notifications. Created Adaptive Cards builder.</div>
                </div>
                <div class="timeline-item">
                    <div class="date">December 27, 2024</div>
                    <div class="title">Phase 2: Queries Stateless</div>
                    <div class="description">Built webhook receiver with HMAC verification. Integrated with Valerie Agent for query processing.</div>
                </div>
                <div class="timeline-item">
                    <div class="date">January 8, 2025</div>
                    <div class="title">Phase 3: Session Management</div>
                    <div class="description">Added Redis session store for conversation memory. Implemented 24-hour TTL.</div>
                </div>
                <div class="timeline-item">
                    <div class="date">January 12, 2025</div>
                    <div class="title">Railway Deployment</div>
                    <div class="description">Deployed to Railway with Redis. Dashboard and documentation added.</div>
                </div>
                <div class="timeline-item">
                    <div class="date">January 12, 2025</div>
                    <div class="title">Webhook Creation Blocked</div>
                    <div class="description">Discovered Microsoft incident MO1176905 preventing Outgoing Webhook creation/configuration.</div>
                </div>
            </div>
        </section>

        <!-- Quick Start -->
        <section>
            <h2>Quick Start</h2>

            <h3>Local Development</h3>
            <div class="code-block"><pre>
# Clone repository
git clone https://github.com/REEA-Global-LLC/client-valence-ms-client.git
cd client-valence-ms-client

# Create virtual environment
python -m venv .venv
source .venv/bin/activate  # On Windows: .venv\Scripts\activate

# Install dependencies
pip install -r requirements/base.txt

# Copy environment configuration
cp .env.example .env

# Edit .env with your configuration
# - Set AGENT_BASE_URL to your Valerie Agent
# - Set SESSION_STORE=redis and REDIS_URL for production

# Run the application
python -m src.main

# Or using make
make run
            </pre></div>

            <h3>Docker Deployment</h3>
            <div class="code-block"><pre>
# Build the image
docker build -t teams-client .

# Run with environment file
docker run -p 3001:3001 --env-file .env teams-client

# Or using docker-compose
docker-compose up -d
            </pre></div>

            <h3>Railway Deployment</h3>
            <div class="code-block"><pre>
# Push to GitHub (Railway auto-deploys from main branch)
git push origin main

# Or deploy manually via Railway CLI
railway up
            </pre></div>
        </section>

        <!-- Project Structure -->
        <section>
            <h2>Project Structure</h2>
            <div class="code-block"><pre>
client-valence-ms-client/
├── src/
│   ├── main.py              # Application entry point
│   ├── core/                # Core modules
│   │   ├── config.py        # Configuration (Pydantic settings)
│   │   ├── logging.py       # Structured logging setup
│   │   └── exceptions.py    # Custom exceptions
│   ├── teams/
│   │   ├── receiver/        # Webhook receiver
│   │   │   ├── models.py    # TeamsMessage, TeamsResponse
│   │   │   ├── hmac.py      # HMAC verification
│   │   │   └── handler.py   # Message handler
│   │   └── sender/          # Notifications (Power Automate)
│   ├── agent/               # Agent client
│   │   ├── client.py        # HTTP client for Valerie Agent
│   │   └── models.py        # Request/Response models
│   ├── session/             # Session management
│   │   ├── store.py         # SessionStore interface
│   │   ├── memory.py        # In-memory store
│   │   └── redis.py         # Redis store
│   ├── dashboard/           # Web dashboard
│   │   └── api.py           # Dashboard endpoints
│   └── notifier/            # Notification service
├── tests/                   # Test suite
├── requirements/            # Dependencies
│   ├── base.txt
│   └── dev.txt
├── Dockerfile
├── railway.toml
└── .env.example
            </pre></div>
        </section>
    </div>

    <!-- Footer -->
    <footer>
        <p><strong>REEA Global</strong> - Valerie MS Teams Client Documentation</p>
        <p>Version 1.0.0 | January 2025</p>
    </footer>
</body>
</html>
